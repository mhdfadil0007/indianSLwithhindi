{% extends 'base.html' %}
{% load static %}

{% block content %}
<div style="display:flex; gap:20px; margin-top:20px;">

  <!-- LEFT PANEL -->
  <div style="width:50%; background:#ffffff; padding:20px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1);">

    <h2 style="text-align:center;">Live Sign Detection</h2>

    <!-- Camera Preview -->
    <video
      id="camera"
      autoplay
      muted
      playsinline
      style="width:100%; height:320px; background:#000; border-radius:10px; margin-top:15px;">
    </video>

    <!-- Hidden canvas -->
    <canvas id="frameCanvas" width="224" height="224" style="display:none;"></canvas>

    <!-- Controls -->
    <div style="text-align:center; margin-top:15px;">
      <button class="submit" onclick="startCamera()">Start Camera</button>
      <button class="submit" onclick="stopCamera()" style="margin-left:10px;">Stop Camera</button>
    </div>

    <!-- Status -->
    <p id="cameraStatus" style="text-align:center; margin-top:10px; font-weight:bold;">
      Camera: OFF
    </p>

    <p style="text-align:center; color:#777; font-size:14px;">
      Please allow camera access to begin live detection.
    </p>
  </div>

  <!-- RIGHT PANEL -->
  <div style="width:50%; background:#ffffff; padding:20px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1);">

    <h2 style="text-align:center;">Detection Output</h2>

    <div style="margin-top:20px;">
      <h3>Detected Sign</h3>
      <div id="detectedSign"
           style="font-size:32px; font-weight:bold; background:#F1EFEC;
                  padding:15px; border-radius:8px; text-align:center;">
        —
      </div>
    </div>

    <div style="margin-top:20px;">
      <h3>Confidence</h3>
      <div style="background:#ddd; border-radius:20px; overflow:hidden;">
        <div id="confidenceBar"
             style="width:0%; background:#030303; color:#fff;
                    padding:8px; text-align:center;">
          0%
        </div>
      </div>
    </div>

    <div style="margin-top:20px;">
      <h3>Detected Sentence</h3>
      <div id="sentenceBox"
           style="min-height:60px; background:#F1EFEC;
                  padding:10px; border-radius:8px;">
      </div>
      <div style="text-align:center; margin-top:10px;">
        <button class="submit" onclick="clearSentence()">Clear</button>
        <button class="submit" onclick="saveToHistory()" style="margin-left:10px;">Save to History</button>
      </div>
    </div>

    <div style="margin-top:20px;">
      <h3>History</h3>
      <ul id="history"
          style="background:#F1EFEC; padding:10px; border-radius:8px; list-style:none; max-height:200px; overflow-y:auto;">
      </ul>
    </div>

  </div>
</div>

<script>
/* ===== GLOBALS ===== */
const video = document.getElementById("camera");
const canvas = document.getElementById("frameCanvas");
const ctx = canvas.getContext("2d");

let stream = null;
let sendInterval = null;

/* ===== SENTENCE FORMATION ===== */
let currentSentence = "";
let lastDetectionTime = null;
let lastDetectedLetter = null;
const PAUSE_THRESHOLD = 2000; // 2 seconds = word break
const CONFIDENCE_THRESHOLD = 0.5; // 50% minimum confidence

/* ===== HISTORY MANAGEMENT ===== */
function loadHistory() {
    const saved = localStorage.getItem("signHistory");
    return saved ? JSON.parse(saved) : [];
}

function saveHistory(history) {
    localStorage.setItem("signHistory", JSON.stringify(history));
}

function renderHistory() {
    const history = loadHistory();
    const historyEl = document.getElementById("history");
    historyEl.innerHTML = "";
    
    history.forEach((item, index) => {
        const li = document.createElement("li");
        li.style.marginBottom = "8px";
        li.style.paddingBottom = "8px";
        li.style.borderBottom = "1px solid #ddd";
        li.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <span style="color:#666; font-size:12px;">${item.time}</span>
                    <br>
                    <strong>${item.text}</strong>
                </div>
                <button onclick="deleteHistoryItem(${index})" style="background:#ff4444; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Delete</button>
            </div>
        `;
        historyEl.appendChild(li);
    });
}

function saveToHistory() {
    if (currentSentence.trim() === "") {
        alert("No sentence to save!");
        return;
    }
    
    const history = loadHistory();
    const now = new Date();
    const timeStr = now.toLocaleDateString() + " " + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    history.unshift({ text: currentSentence.trim(), time: timeStr });
    saveHistory(history);
    renderHistory();
    
    currentSentence = "";
    lastDetectedLetter = null;
    lastDetectionTime = null;
    document.getElementById("sentenceBox").innerText = "";
    document.getElementById("detectedSign").innerText = "—";
    document.getElementById("confidenceBar").style.width = "0%";
    document.getElementById("confidenceBar").innerText = "0%";
}

function deleteHistoryItem(index) {
    const history = loadHistory();
    history.splice(index, 1);
    saveHistory(history);
    renderHistory();
}

function clearSentence() {
    currentSentence = "";
    lastDetectedLetter = null;
    lastDetectionTime = null;
    document.getElementById("sentenceBox").innerText = "";
    document.getElementById("detectedSign").innerText = "—";
    document.getElementById("confidenceBar").style.width = "0%";
    document.getElementById("confidenceBar").innerText = "0%";
}

function processDetection(letter, confidence) {
    const now = Date.now();
    
    // Skip low confidence detections
    if (confidence < CONFIDENCE_THRESHOLD) {
        return;
    }
    
    // Skip placeholder
    if (letter === "-" || letter === "") {
        return;
    }
    
    // Check for pause (word break)
    if (lastDetectionTime && (now - lastDetectionTime) > PAUSE_THRESHOLD) {
        // Add space if last char wasn't a space
        if (currentSentence.length > 0 && !currentSentence.endsWith(" ")) {
            currentSentence += " ";
        }
    }
    
    // Skip consecutive duplicates
    if (lastDetectedLetter === letter && currentSentence.endsWith(letter)) {
        // Still update the time
        lastDetectionTime = now;
        return;
    }
    
    // Add letter to sentence
    currentSentence += letter;
    lastDetectedLetter = letter;
    lastDetectionTime = now;
    
    // Update UI
    document.getElementById("sentenceBox").innerText = currentSentence;
}

/* ===== START CAMERA ===== */
async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        await video.play();

        document.getElementById("cameraStatus").innerText = "Camera: ON";

        sendInterval = setInterval(sendFrame, 400);
        console.log("Camera started");
    } catch (err) {
        console.error("Camera error:", err);
        alert("Camera permission denied");
    }
}

/* ===== STOP CAMERA ===== */
function stopCamera() {
    if (sendInterval) {
        clearInterval(sendInterval);
        sendInterval = null;
    }

    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }

    video.srcObject = null;
    document.getElementById("cameraStatus").innerText = "Camera: OFF";
    console.log("Camera stopped");
}

/* ===== SEND FRAME TO BACKEND ===== */
async function sendFrame() {
    if (!stream || video.videoWidth === 0) return;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const frame = canvas.toDataURL("image/jpeg");

    try {
        const res = await fetch("/receive-frame/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ frame })
        });

        const data = await res.json();

        if (data.label !== undefined) {
            document.getElementById("detectedSign").innerText = data.label;

            const conf = Math.round(data.confidence * 100);
            const bar = document.getElementById("confidenceBar");
            bar.style.width = conf + "%";
            bar.innerText = conf + "%";
            
            // Process letter for sentence formation
            processDetection(data.label, data.confidence);
        }
    } catch (e) {
        console.warn("Frame send failed");
    }
}

/* ===== INIT ===== */
document.addEventListener("DOMContentLoaded", function() {
    renderHistory();
});
</script>
{% endblock %}
